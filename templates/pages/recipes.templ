package pages

import (
	"fmt"
	"strconv"
	"strings"
	"github.com/bensuskins/family-hub/internal/models"
	"github.com/bensuskins/family-hub/templates/components"
	"github.com/bensuskins/family-hub/templates/layouts"
)

type RecipeListProps struct {
	User        models.User
	Recipes     []models.Recipe
	CategoryMap map[string]string
}

type RecipeDetailProps struct {
	User         models.User
	Recipe       models.Recipe
	CategoryName string
}

type RecipeFormProps struct {
	User       models.User
	Recipe     *models.Recipe
	Categories []models.Category
	IsEdit     bool
}

templ RecipeList(props RecipeListProps) {
	@layouts.Base("Recipes", props.User, "/recipes") {
		<div class="space-y-6">
			@components.PageHeaderWithAction("Recipes", "Your family's recipe collection") {
				<a href="/recipes/new" class="inline-flex items-center gap-1.5 bg-stone-700 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-stone-800">
					@components.IconPlus("h-4 w-4")
					New Recipe
				</a>
			}

			if len(props.Recipes) == 0 {
				<div class="bg-white border border-stone-200 rounded-xl p-8 text-center text-stone-500">
					<p>No recipes yet. Add your first recipe!</p>
				</div>
			} else {
				<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
					for _, recipe := range props.Recipes {
						<a href={ templ.SafeURL(fmt.Sprintf("/recipes/%s", recipe.ID)) } class="block bg-white border border-stone-200 rounded-xl p-5 hover:border-stone-300 hover:shadow-card transition-all">
							<h3 class="text-lg font-medium text-stone-900 mb-2">{ recipe.Title }</h3>
							<div class="flex flex-wrap gap-2 items-center text-sm text-stone-500">
								if recipe.CategoryID != nil {
									<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700">
										{ recipeCategory(props.CategoryMap, *recipe.CategoryID) }
									</span>
								}
								if recipe.Servings != nil {
									<span>{ fmt.Sprintf("%d servings", *recipe.Servings) }</span>
								}
								if recipe.PrepTime != nil {
									<span>Prep: { *recipe.PrepTime }</span>
								}
								if recipe.CookTime != nil {
									<span>Cook: { *recipe.CookTime }</span>
								}
							</div>
						</a>
					}
				</div>
			}
		</div>
	}
}

templ RecipeDetail(props RecipeDetailProps) {
	@layouts.Base(props.Recipe.Title, props.User, "/recipes") {
		<div class="max-w-3xl mx-auto space-y-6">
			<div class="flex justify-between items-start">
				<div>
					<h1 class="text-2xl font-bold text-stone-900">{ props.Recipe.Title }</h1>
					if props.CategoryName != "" {
						<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 mt-2">
							{ props.CategoryName }
						</span>
					}
				</div>
				<div class="flex space-x-2">
					<a href={ templ.SafeURL(fmt.Sprintf("/recipes/%s/edit", props.Recipe.ID)) } class="inline-flex items-center gap-1.5 bg-stone-700 text-white px-3 py-1.5 rounded-xl text-sm font-medium hover:bg-stone-800">
						@components.IconPencil("h-4 w-4")
						Edit
					</a>
					<form method="POST" action={ templ.SafeURL(fmt.Sprintf("/recipes/%s/delete", props.Recipe.ID)) } class="inline">
						<button type="submit" onclick="return confirm('Delete this recipe?')" class="inline-flex items-center gap-1.5 bg-red-600 text-white px-3 py-1.5 rounded-xl text-sm font-medium hover:bg-red-700">
							@components.IconTrash("h-4 w-4")
							Delete
						</button>
					</form>
				</div>
			</div>

			<!-- Metadata -->
			<div class="flex flex-wrap gap-4 text-sm text-stone-600">
				if props.Recipe.Servings != nil {
					<div class="flex items-center gap-1">
						<span class="font-medium">Servings:</span>
						<span>{ fmt.Sprintf("%d", *props.Recipe.Servings) }</span>
					</div>
				}
				if props.Recipe.PrepTime != nil {
					<div class="flex items-center gap-1">
						<span class="font-medium">Prep:</span>
						<span>{ *props.Recipe.PrepTime }</span>
					</div>
				}
				if props.Recipe.CookTime != nil {
					<div class="flex items-center gap-1">
						<span class="font-medium">Cook:</span>
						<span>{ *props.Recipe.CookTime }</span>
					</div>
				}
				if props.Recipe.SourceURL != nil {
					<div class="flex items-center gap-1">
						@components.IconLink("h-4 w-4 text-blue-600")
						<a href={ templ.SafeURL(*props.Recipe.SourceURL) } target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">Source</a>
					</div>
				}
			</div>

			<!-- Ingredients -->
			if len(props.Recipe.Ingredients) > 0 {
				<div class="bg-white border border-stone-200 rounded-xl p-6">
					<h2 class="text-lg font-medium text-stone-900 mb-4">Ingredients</h2>
					for _, group := range props.Recipe.Ingredients {
						if group.Name != "" && group.Name != "Main" {
							<h3 class="text-sm font-medium text-stone-700 mt-3 mb-1">{ group.Name }</h3>
						}
						<ul class="list-disc list-inside space-y-1 text-sm text-stone-700">
							for _, item := range group.Items {
								<li>{ item }</li>
							}
						</ul>
					}
				</div>
			}

			<!-- Instructions -->
			if props.Recipe.Instructions != "" {
				<div class="bg-white border border-stone-200 rounded-xl p-6">
					<h2 class="text-lg font-medium text-stone-900 mb-4">Instructions</h2>
					<div class="text-sm text-stone-700 whitespace-pre-wrap">{ props.Recipe.Instructions }</div>
				</div>
			}

			<div class="pt-2">
				<a href="/recipes" class="inline-flex items-center gap-1 text-stone-600 hover:text-stone-900 text-sm">
					@components.IconChevronLeft("h-4 w-4")
					Back to recipes
				</a>
			</div>
		</div>
	}
}

templ RecipeForm(props RecipeFormProps) {
	@layouts.Base(recipeFormTitle(props.IsEdit), props.User, "/recipes") {
		<div class="max-w-2xl mx-auto">
			<h1 class="text-2xl font-bold text-stone-900 mb-6">{ recipeFormTitle(props.IsEdit) }</h1>

			<form
				if props.IsEdit && props.Recipe != nil {
					action={ templ.SafeURL(fmt.Sprintf("/recipes/%s", props.Recipe.ID)) }
				} else {
					action="/recipes"
				}
				method="POST"
				class="space-y-6 bg-white border border-stone-200 rounded-xl p-6"
			>
				<div>
					<label for="title" class="block text-sm font-medium text-stone-700">Title</label>
					<input
						type="text"
						id="title"
						name="title"
						required
						if props.Recipe != nil {
							value={ props.Recipe.Title }
						}
					/>
				</div>

				<div>
					<label for="category_id" class="block text-sm font-medium text-stone-700">Category</label>
					<select id="category_id" name="category_id">
						<option value="">No Category</option>
						for _, cat := range props.Categories {
							<option
								value={ cat.ID }
								if props.Recipe != nil && props.Recipe.CategoryID != nil && *props.Recipe.CategoryID == cat.ID {
									selected
								}
							>{ cat.Name }</option>
						}
					</select>
				</div>

				<div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
					<div>
						<label for="servings" class="block text-sm font-medium text-stone-700">Servings</label>
						<input
							type="number"
							id="servings"
							name="servings"
							min="1"
							if props.Recipe != nil && props.Recipe.Servings != nil {
								value={ strconv.Itoa(*props.Recipe.Servings) }
							}
						/>
					</div>
					<div>
						<label for="prep_time" class="block text-sm font-medium text-stone-700">Prep Time</label>
						<input
							type="text"
							id="prep_time"
							name="prep_time"
							placeholder="e.g. 15 min"
							if props.Recipe != nil && props.Recipe.PrepTime != nil {
								value={ *props.Recipe.PrepTime }
							}
						/>
					</div>
					<div>
						<label for="cook_time" class="block text-sm font-medium text-stone-700">Cook Time</label>
						<input
							type="text"
							id="cook_time"
							name="cook_time"
							placeholder="e.g. 30 min"
							if props.Recipe != nil && props.Recipe.CookTime != nil {
								value={ *props.Recipe.CookTime }
							}
						/>
					</div>
				</div>

				<div>
					<label for="source_url" class="block text-sm font-medium text-stone-700">Source URL</label>
					<input
						type="url"
						id="source_url"
						name="source_url"
						placeholder="https://..."
						if props.Recipe != nil && props.Recipe.SourceURL != nil {
							value={ *props.Recipe.SourceURL }
						}
					/>
				</div>

				<!-- Ingredient Groups -->
				<div>
					<label class="block text-sm font-medium text-stone-700 mb-2">Ingredients</label>
					<div id="ingredient-groups" class="space-y-4">
						if props.Recipe != nil && len(props.Recipe.Ingredients) > 0 {
							for index, group := range props.Recipe.Ingredients {
								@IngredientGroupFields(index, group)
							}
						} else {
							@IngredientGroupFields(0, models.IngredientGroup{Name: "Main"})
						}
					</div>
					<button
						type="button"
						hx-get="/recipes/ingredient-group"
						hx-vals="js:{index: document.querySelectorAll('#ingredient-groups > div').length}"
						hx-target="#ingredient-groups"
						hx-swap="beforeend"
						class="mt-3 text-sm text-stone-600 hover:text-stone-900 font-medium"
					>
						+ Add Ingredient Group
					</button>
				</div>

				<div>
					<label for="instructions" class="block text-sm font-medium text-stone-700">Instructions</label>
					<textarea
						id="instructions"
						name="instructions"
						rows="8"
					>
						if props.Recipe != nil {
							{ props.Recipe.Instructions }
						}
					</textarea>
				</div>

				<div class="flex justify-end space-x-3">
					<a href="/recipes" class="bg-white py-2 px-4 border border-stone-200 rounded-xl shadow-sm text-sm font-medium text-stone-700 hover:bg-stone-50">Cancel</a>
					<button type="submit" class="bg-stone-700 py-2 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white hover:bg-stone-800">
						if props.IsEdit {
							Update
						} else {
							Create
						}
					</button>
				</div>
			</form>
		</div>
	}
}

templ IngredientGroupFields(index int, group models.IngredientGroup) {
	<div class="border border-stone-200 rounded-xl p-4 bg-stone-50 relative" id={ fmt.Sprintf("ingredient-group-%d", index) }>
		if index > 0 {
			<button
				type="button"
				onclick="this.closest('[id^=ingredient-group-]').remove(); document.querySelectorAll('#ingredient-groups > div').forEach(function(div, i) { div.id = 'ingredient-group-' + i; div.querySelectorAll('input, textarea').forEach(function(el) { el.name = el.name.replace(/_\d+$/, '_' + i); }); })"
				class="absolute top-2 right-2 text-stone-400 hover:text-red-600 text-sm"
			>
				Remove
			</button>
		}
		<div class="mb-3">
			<label class="block text-sm font-medium text-stone-700">Group Name</label>
			<input
				type="text"
				name={ fmt.Sprintf("group_name_%d", index) }
				value={ group.Name }
				placeholder="e.g. Sauce, Dough, Filling"
			/>
		</div>
		<div>
			<label class="block text-sm font-medium text-stone-700">Items (one per line)</label>
			<textarea
				name={ fmt.Sprintf("group_items_%d", index) }
				rows="4"
				placeholder="2 cups flour&#10;1 tsp salt&#10;3 eggs"
			>{ strings.Join(group.Items, "\n") }</textarea>
		</div>
	</div>
}

func recipeFormTitle(isEdit bool) string {
	if isEdit {
		return "Edit Recipe"
	}
	return "New Recipe"
}

func recipeCategory(categoryMap map[string]string, categoryID string) string {
	if name, ok := categoryMap[categoryID]; ok {
		return name
	}
	return "Unknown"
}
